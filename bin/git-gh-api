#!/bin/bash

method="$1"; shift
url="$1"; shift
body="$*"
token=$(git gh-oauth)

test -z "$method" && echo "http method required" 1>&2 && exit 42
test -z "$(echo -e "GET\nPOST\nDELETE" | grep "^$method$")" && echo "invalid http method" 1>&2 && exit 43
test -z "$url" && echo "url required" 1>&2 && exit 42
test -z "$token" && echo "access token required." 1>&2 && exit 42

response=$(curl -sSX $method https://api.github.com$url \
                      -H "Authorization: token $token"  \
                      -d "$body" --write-out "%{http_code}")

json=`echo $response | sed 's/...$//'`
http_code=`echo -e "$response" | tail -1`

if [ "${http_code:0:1}" == "2" ] ; then
  printf "$json"
else
  printf "$json" | gh-json message 1>&2
  exit $((http_code - 300))
fi
